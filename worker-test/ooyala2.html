<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bitmovin Player Test</title>
  <script type="text/javascript" src="https://bitmovin-a.akamaihd.net/bitmovin-player/stable/7.2.1/bitmovinplayer.js"></script>
  <script type="text/javascript" src="./bitmovinanalytics.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
</head>
<body>
  <div style="margin: 0 auto; width: 600px">
    <h1 style="text-align: center;">Bitmovin Player Test</h1>
    <div id="player" style="width: 600px"></div>
    <h3>Task</h3>
    <p style="text-align: left">
        <ol>
          <li>Start Playback of the Video (Click on the above Player)</li>
          <li>Watch the Video for about 20 Seconds</li>
          <li>Jump to another location in the Video</li>
          <li>Watch another 20 Seconds</li>
          <li>Press Pause</li>
          <li>Rate your satisfaction with the Playback of the Video below</li>
        </ol>
        <div class="survey">
          <h3>Please Rate your Experience</h3>
          <div class="radio">
            <label>
              <input type="radio" name="experience" value="1" /> Very Dissatisfied
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" name="experience" value="2" /> Somewhat Dissatisfied
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" name="experience" value="3" /> Neither
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" name="experience" value="4" /> Somewhat Satisfied
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" name="experience" value="5" /> Very Satisfied
            </label>
          </div>
          <button disabled="disabled" class="btn btn-primary" id="take-survey">Submit</button>
        </div>
    </p>
    <h2 style="display: none" id="thanks">Thank you - your code is 2B3AD5D7</h3>

  </div>
  <script type="text/javascript">

    var config = {
      key: "e73a3577-d91c-4214-9e6d-938fb936818a", //Your bitmovin analytics key
      playerKey: "a6e31908-550a-4f75-b4bc-a9d89880a733", //Your player key (bitmovin, jw, ..) (optional)
      player: bitmovin.analytics.Players.BITMOVIN,
      cdnProvider: bitmovin.analytics.CdnProviders.AKAMAI,
      experimentName: 'Ooyala',
      videoId: 'Sintel',
      customData1: -1

    };
    var analytics = bitmovin.analytics(config);

    var player;
    var url = 'https://player.ooyala.com/sas/player_api/v2/authorization/embed_code/8yMGYyOvhG5HuuITgXl_UUwes_5e/FqM3EwODE692MhTI9X0bHx4mj7ZvrquU?embedToken=http%3A%2F%2Fplayer.ooyala.com%2Fsas%2Fembed_token%2F8yMGYyOvhG5HuuITgXl_UUwes_5e%2FFqM3EwODE692MhTI9X0bHx4mj7ZvrquU%3Faccount_id%3D95032%26api_key%3D8yMGYyOvhG5HuuITgXl_UUwes_5e.Bk0HN%26expires%3D1580569200%26signature%3DpY3ZitMpsnI9waunSDiiGcmU06ub522QcINCqVOWT2I%26override_syndication_group%3Doverride_all_synd_groups&device=html5&domain=jpfranco.github.io';

    load(url, function (response) {
      getDashManifestFromOoyalaResponse(JSON.parse(response));
    });

    function getDashManifestFromOoyalaResponse(jsonData) {
      var tmp = jsonData.authorization_data;
      for (var key in tmp) {
        if (tmp.hasOwnProperty(key)) {
          tmp = tmp[key];
          break;
        }
      }

      for (var i = 0; i < tmp.streams.length; i++) {
        if (tmp.streams[i].delivery_type.indexOf('dash') > -1) {
          tmp = tmp.streams[i];
          break;
        }
      }

      if (tmp.drm) {
        for (var drmSystem in tmp.drm) {
          if (tmp.drm.hasOwnProperty(drmSystem) && tmp.drm[drmSystem].la_url) {
            tmp.drm[drmSystem].LA_URL = tmp.drm[drmSystem].la_url;
            delete tmp.drm[drmSystem].la_url;
          }
        }
      }
      loadPlayer(atob(tmp.url.data), tmp.drm);
    }

    function load(url, callback) {
      var request = new XMLHttpRequest();
      request.open('GET', url);
      request.addEventListener('readystatechange', onReadyStateChanged);

      function onReadyStateChanged() {
        if (request.readyState === request.DONE) {
          request.removeEventListener('readystatechange', onReadyStateChanged);

          callback(request.response);
        }
      }

      request.send();
    }

    function loadPlayer(dashSource, drm) {
      var conf = {
        key: '89f6ed6c-ab0e-46c2-ac47-5665e60c3c41',
        source: {
          dash: dashSource
        }
      };

      if (drm) {
        conf.source.drm = drm;
      }

      player = bitmovin.player('player');
      player.setup(conf).then(function () {
        player.preload();
      });
      analytics.register(player);
      setupInterval();
    }
    load();

    document.getElementById('take-survey').onclick = function () {
      var result = document.querySelector('input[name="experience"]:checked').value;
      analytics.setCustomDataOnce({ customData1: result });
      document.getElementById('take-survey').disabled = true;
      document.getElementById('thanks').style.display = 'block';
    };
    function setupInterval() {
      var started = false;
      player.addEventHandler(bitmovin.player.EVENT.ON_PLAY, function () {
        if (started === false) {
          started = new Date();
        }
        window.setInterval(function () {
          var now = new Date();
          if (now - started > 40000) {
            document.getElementById('take-survey').disabled = false;
          }
        }, 500);
      });
    }
  </script>
</body>
</html>
